name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.0.app

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('Velo.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Build for iOS Simulator
        run: |
          xcodebuild build \
            -project Velo.xcodeproj \
            -scheme Velo \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Run Unit Tests
        run: |
          xcodebuild test \
            -project Velo.xcodeproj \
            -scheme Velo \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODO comments
        run: |
          if grep -r "TODO:" --include="*.swift" Velo/; then
            echo "::warning::Found TODO comments in code"
          fi

      - name: Check for FIXME comments
        run: |
          if grep -r "FIXME:" --include="*.swift" Velo/; then
            echo "::warning::Found FIXME comments in code"
          fi

      - name: Check for force unwraps
        run: |
          # Match force unwraps: identifier followed by ! (excluding != and string literals)
          # Pattern: word character followed by ! not followed by = or inside quotes
          if grep -rE "[a-zA-Z0-9_\)]\!($|[^=])" --include="*.swift" Velo/ | grep -v "import\|//\|\".*!.*\"\|#if\|#endif" | head -20; then
            echo "::warning::Found potential force unwraps - review needed"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          # Check for potential API keys or secrets
          if grep -rE "(api_key|apikey|secret|password|token)" --include="*.swift" Velo/ | grep -v "Constants\|Secrets\|//"; then
            echo "::warning::Found potential hardcoded secrets - review needed"
          fi

      - name: Check for sensitive data in logs
        run: |
          # Check for potential sensitive data being logged
          if grep -rE "Logger\.(info|debug|error).*token" --include="*.swift" Velo/; then
            echo "::error::Found potential token logging - security review needed"
            exit 1
          fi
